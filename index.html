<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CrossTraining ‚Äì Projet √âl√®ve</title>
<style>
:root{--green:#2ecc71;--blue:#3498db;--red:#e74c3c;--yellow:#f1c40f;--bg:#f7f7fb;--card:#fff;--muted:#6b7280;--ink:#111827;--border:#e5e7eb}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
.wrap{max-width:1200px;margin:0 auto;padding:16px}.h1{margin:0;font-size:1.6rem;font-weight:900;text-align:center}.subtitle{color:var(--muted);text-align:center;margin-top:4px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;justify-content:center}
.btn{appearance:none;border:1px solid transparent;background:var(--blue);color:#fff;padding:10px 14px;border-radius:14px;font-weight:650;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.06)}
.btn:hover{filter:brightness(1.05)}.btn:active{transform:translateY(1px)}.btn.green{background:var(--green)}.btn.red{background:var(--red)}.btn.yellow{background:var(--yellow);color:#111}.btn.violet{background:#f1c40f}.btn.outline{background:#fff;color:#111;border-color:var(--border)}
.panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px}.panel h2{margin:0 0 10px;font-size:1.08rem}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}@media(max-width:980px){.grid{grid-template-columns:repeat(6,1fr)}}@media(max-width:680px){.grid{grid-template-columns:repeat(2,1fr)}}
label{color:var(--muted);font-size:.92rem}input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font:inherit}
.small{color:var(--muted);font-size:.92rem}.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:12px}.row{display:flex;gap:8px;flex-wrap:wrap}
.list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}@media(max-width:920px){.list{grid-template-columns:1fr}}.item{border:1px solid var(--border);border-radius:12px;padding:10px}.item .meta{font-size:.85rem;color:var(--muted)}
.table{width:100%;border-collapse:separate;border-spacing:0}.table th,.table td{border:1px solid var(--border);padding:8px 10px}.table th{background:#f8fafc;text-align:left}
.center{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:40vh}.timerBox{display:grid;grid-template-columns:1fr 1fr;gap:12px}@media(max-width:860px){.timerBox{grid-template-columns:1fr}}
.big{font-size:3rem;font-weight:900;text-align:center}.bigger{font-size:4.2rem;font-weight:900;text-align:center}.phase{font-size:1rem;color:var(--muted);text-align:center}
.blocks{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}.block{border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center;background:#fff}.block.active{border-color:#60a5fa;background:#eff6ff}
.glow10{box-shadow:0 0 0 4px #fde68a inset}footer{margin:28px 0 60px;color:var(--muted);font-size:.85rem;text-align:center}
.thumb{width:72px;height:72px;border-radius:10px;border:1px solid var(--border);object-fit:cover;flex:0 0 auto}.skill{display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center}
#flashFx{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity 180ms ease}#flashFx.show{opacity:.55}
#diag{position:fixed;left:8px;bottom:8px;z-index:9999;max-width:420px;background:#111827;color:#fff;border-radius:12px;border:1px solid #374151;box-shadow:0 10px 24px rgba(0,0,0,.35);display:none}
#diag header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #374151;font-weight:800;font-size:.92rem}#diag .body{max-height:40vh;overflow:auto;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.86rem;white-space:pre-wrap;word-break:break-word}
#diag .ok{color:#34d399}.warn{color:#f59e0b}.err{color:#f87171}#diag .row{display:flex;gap:8px;align-items:center}#diag button{border-radius:10px;border:1px solid #374151;background:#1f2937;color:#fff;padding:6px 10px;cursor:pointer}#diag .pill{border:1px solid #374151;border-radius:999px;padding:2px 8px;font-size:.8rem;background:#1f2937;color:#a7f3d0}
@media print{header,.noPrint{display:none!important}.panel{box-shadow:none}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="h1">CrossTraining ‚Äì Projet √âl√®ve</div>
    <div class="subtitle">Je con√ßois mes 4 skills ‚Üí Je r√©alise 10 blocs (4 skills + course) ‚Üí R√©sum√© & QR/Export</div>
    <div class="toolbar" style="justify-content:flex-end">
      <button class="btn outline noPrint" onclick="toggleDiag()">üîé Diagnostic</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="home" class="center">
    <div style="text-align:center">
      <h1 style="margin:0 0 8px">CrossTraining ‚Äì Projet √âl√®ve</h1>
      <div class="small" style="margin-bottom:16px">Appli simple pour <strong>concevoir</strong> ton √©valuation, la <strong>r√©aliser</strong> avec un chrono, et <strong>r√©sumer</strong> tes r√©sultats.</div>
      <div class="toolbar">
        <button class="btn green" onclick="go('builder')">üöÄ D√©marrer</button>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn outline" onclick="openSafety()">üõ°Ô∏è Fiche s√©curit√©</button>
        <button class="btn violet" onclick="openHelp()">‚ùì Aide</button>
      </div>
    </div>
  </section>

  <section id="builder" class="panel" style="display:none">
    <h2>Identit√© & Construction des 4 skills</h2>
    <div class="grid">
      <div style="grid-column:span 3"><label>Nom</label><input id="b_nom"></div>
      <div style="grid-column:span 3"><label>Pr√©nom</label><input id="b_prenom"></div>
      <div style="grid-column:span 3"><label>Classe</label><input id="b_classe" placeholder="2nde3"></div>
      <div style="grid-column:span 3"><label>Sexe</label><input id="b_sex" placeholder="F/M"></div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="row">
        <label class="btn outline" for="csvCat">üì• Importer catalogue</label>
        <input id="csvCat" type="file" accept=".csv,text/csv" style="display:none">
        <button class="btn outline" onclick="loadDemoCatalogue()">üß™ Charger un exemple</button>
      </div>
      <div class="grid" style="margin-top:10px">
        <div style="grid-column:span 4"><label>Recherche</label><input id="f_search" oninput="renderCatalogue()" placeholder="burpee, gainage‚Ä¶"></div>
        <div style="grid-column:span 4"><label>Famille</label><select id="f_fam" onchange="renderCatalogue()"></select></div>
        <div style="grid-column:span 4"><label>Type</label><select id="f_type" onchange="renderCatalogue()"></select></div>
      </div>
      <div class="list" id="catList" style="margin-top:10px"></div>
    </div>

    <div class="panel" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Mes 4 skills</h3>
      <div id="slots"></div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end">
        <button class="btn" onclick="goEval()" id="toEval" disabled>‚ñ∂Ô∏è Passer au chrono</button>
      </div>
    </div>
  </section>

  <section id="eval" class="panel" style="display:none">
    <h2>√âvaluation ‚Äì 20 minutes (10 blocs de 2')</h2>
    <div class="timerBox">
      <div class="card">
        <div class="small" style="text-align:center">Chrono g√©n√©ral</div>
        <div class="bigger" id="gDisplay">20:00</div>
        <div class="row" style="justify-content:center;margin-top:8px">
          <button class="btn" onclick="startTimers()">‚ñ∂Ô∏è Start</button>
          <button class="btn outline" onclick="pauseTimers()">‚è∏Ô∏è Pause</button>
          <button class="btn red" onclick="resetTimers()">‚ü≤ Reset</button>
        </div>
        <div class="row" style="justify-content:center;margin-top:6px">
          <label class="small" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="enableBeep" checked> üîî Bip</label>
          <label class="small" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="enableFlash" checked> ‚ú® Flash</label>
          <label class="small" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="enableVibe"> üì≥ Vibreur</label>
        </div>
      </div>
      <div class="card">
        <div class="small" style="text-align:center">Bloc <span id="bIdx">1</span>/10 ‚Äì 4 skills + course</div>
        <div class="big" id="bDisplay">00:00</div>
        <div class="phase" id="phase">Travail</div>
        <div class="row" style="justify-content:center;margin-top:8px">
          <button id="recordBtn" class="btn" onclick="recordWork()">üìù Enregistrer fin du travail</button>
        </div>
        <div class="small" style="text-align:center;margin-top:8px">Astuce : clique d√®s que tu termines tes 4 skills + ta course. Le chrono continue jusqu'√† 2' (r√©cup).</div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="small">Blocs (2' chacun) ‚Äì surbrillance = bloc en cours. Les <strong>10 derni√®res secondes</strong> clignotent.</div>
      <div class="blocks" id="blocks"></div>
    </div>

    <div class="panel" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Tableau des temps</h3>
      <div style="overflow:auto">
        <table class="table"><thead><tr><th>#</th><th>Travail (sec)</th><th>Pause (sec)</th><th>Corriger</th></tr></thead>
        <tbody id="timesTbody"></tbody></table>
      </div>
      <div class="toolbar" style="justify-content:flex-end;margin-top:8px">
        <button class="btn" onclick="finishEval()">‚úÖ Terminer & R√©sum√©</button>
      </div>
    </div>
  </section>

  <section id="summary" class="panel" style="display:none">
    <h2>R√©sum√©</h2>
    <div id="sumIdent" class="small"></div>
    <div class="panel" style="margin-top:10px">
      <h3 style="margin:0 0 6px">4 skills choisis</h3>
      <div id="sumSkills"></div>
    </div>
    <div class="panel" style="margin-top:10px">
      <h3 style="margin:0 0 6px">Temps par bloc</h3>
      <div id="sumTimes"></div>
    </div>
    <div class="panel" style="margin-top:10px">
      <h3 style="margin:0 0 6px">Ressenti</h3>
      <textarea id="sumFeel" rows="3" placeholder="Comment as-tu v√©cu la s√©ance ?"></textarea>
    </div>
    <div class="toolbar" style="justify-content:flex-end;margin-top:8px">
      <button class="btn outline" onclick="print()">üñ®Ô∏è PDF (imprimer)</button>
      <button class="btn outline" onclick="exportCsv()">‚¨áÔ∏è Export CSV</button>
      <button class="btn" onclick="openQR()">üßæ QR (compact ScanProf)</button>
      <button class="btn red" onclick="go('home')">üè† Revenir √† l'accueil</button>
    </div>
  </section>

  <footer>CrossTraining ‚Äì Projet √âl√®ve ‚Ä¢ √âquipe EPS ‚Äì JB</footer>
</main>

<div id="flashFx" aria-hidden="true"></div>

<div id="diag"><header><span>Diagnostic</span><div class="row"><span class="pill">v1</span><button onclick="document.getElementById('diag').style.display='none'">‚úñ</button></div></header><div class="body" id="diagBody"></div></div>

<dialog id="dlgSafety"><div style="padding:16px;max-width:800px">
  <h3 style="margin:0 0 8px">Fiche de s√©curit√©</h3>
  <ul class="small" style="margin:6px 0 0 18px">
    <li><strong>Aucun mat√©riel</strong> autre que chaises/bancs stables et intacts.</li>
    <li>Zone <strong>d√©gag√©e</strong>, sol non glissant, parcours de course <strong>d√©limit√©</strong> et en <strong>sens unique</strong>.</li>
    <li>√âchauffement 8‚Äì10 min, intensit√© 6‚Äì7/10, hydratation, arr√™t si douleur/g√™ne.</li>
    <li>Interdits : sauts depuis le banc, pieds sur dossier instable, port√©s.</li>
  </ul>
  <div class="toolbar" style="justify-content:flex-end"><button class="btn outline" onclick="closeSafety()">Fermer</button></div>
</div></dialog>

<dialog id="dlgHelp"><div style="padding:16px;max-width:800px">
  <h3 style="margin:0 0 8px">Aide</h3>
  <ol>
    <li><strong>D√©marrer</strong> ‚Üí Saisis identit√© puis <strong>choisis 4 skills</strong> dans le <em>catalogue</em> (niveau L1/L2 + r√©p√©titions pr√©vues).</li>
    <li><strong>Chrono</strong> ‚Üí 20 min = 10 blocs de 2'. Clique ‚ÄúEnregistrer fin du travail‚Äù quand tu as fini 4 skills + course. Le reste = r√©cup.</li>
    <li><strong>R√©sum√©</strong> ‚Üí V√©rifie, ajoute le <em>ressenti</em>, exporte en <em>CSV</em> ou affiche le <em>QR compact</em>.</li>
  </ol>
  <div class="small">Familles : <strong>Cardio training</strong> ‚Ä¢ <strong>Gainage abdo</strong> ‚Ä¢ <strong>Membres sup</strong> ‚Ä¢ <strong>Membres inf</strong>.</div>
  <div class="toolbar" style="justify-content:flex-end"><button class="btn outline" onclick="closeHelp()">Fermer</button></div>
</div></dialog>

<dialog id="qrDlg"><div style="padding:16px;max-width:900px">
  <div class="row" style="justify-content:space-between;align-items:center"><strong>QR (ScanProf ‚Äì compact)</strong>
    <div class="toolbar"><button class="btn yellow" onclick="print()">üñ®Ô∏è Imprimer</button><button class="btn outline" onclick="closeQR()">Fermer</button></div>
  </div>
  <div id="qrWrap" class="row" style="margin-top:12px;justify-content:center"></div>
</div></dialog>

<script>
function toggleDiag(){ const el=document.getElementById('diag'); el.style.display=(el.style.display==='block'?'none':'block') }
function logDiag(line, cls=''){ const b=document.getElementById('diagBody'); const d=document.createElement('div'); if(cls) d.className=cls; d.textContent=line; b.appendChild(d); document.getElementById('diag').style.display='block' }
window.onerror=(m,src,ln,col)=>logDiag('[JS ERROR] '+m+' @ '+ln+':'+col,'err')
window.addEventListener('unhandledrejection',e=>logDiag('[PROMISE] '+(e.reason&&e.reason.message?e.reason.message:e.reason),'err'))
const FAMILLES=["Cardio training","Gainage abdo","Membres sup","Membres inf"]
const TYPES=["REPS","TIME","BOOL","KG"]
const qs=new URLSearchParams(location.search); const SAFE=qs.get('safe')==='1'
const state={
  identity:{nom:'',prenom:'',classe:'',sex:''},
  catalogue:[],
  slots:[
    {ref:'S1',exId:null,nom:'',famille:'',type:'REPS',unite:'',niveau:1,ptsN1:0,ptsN2:0,reps:'',img:''},
    {ref:'S2',exId:null,nom:'',famille:'',type:'REPS',unite:'',niveau:1,ptsN1:0,ptsN2:0,reps:'',img:''},
    {ref:'S3',exId:null,nom:'',famille:'',type:'REPS',unite:'',niveau:1,ptsN1:0,ptsN2:0,reps:'',img:''},
    {ref:'S4',exId:null,nom:'',famille:'',type:'REPS',unite:'',niveau:1,ptsN1:0,ptsN2:0,reps:'',img:''},
  ],
  eval:{gRemain:20*60,bElapsed:0,block:1,timer:null,recorded:{}}
}
function $(id){return document.getElementById(id)}
function go(view){ ['home','builder','eval','summary'].forEach(v=>$(v).style.display=(v===view?'block':'none')) }
function openSafety(){ const d=$('dlgSafety'); if(d.showModal) d.showModal(); else d.style.display='block' }
function closeSafety(){ const d=$('dlgSafety'); if(d.close) d.close(); else d.style.display='none' }
function openHelp(){ const d=$('dlgHelp'); if(d.showModal) d.showModal(); else d.style.display='block' }
function closeHelp(){ const d=$('dlgHelp'); if(d.close) d.close(); else d.style.display='none' }
function stripAccents(s){return (s||'').normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'')}
function normFamily(raw,name){
  const s=(stripAccents(raw||'')+' '+stripAccents(name||'')).toLowerCase(); const has=k=>s.includes(k)
  if(has('cardio')||has('course')||has('run')||has('rameur')||has('burpee'))return'Cardio training'
  if(has('gainage')||has('planch')||has('abdo')||has('core')||has('hollow'))return'Gainage abdo'
  if(has('push')||has('pomp')||has('traction')||has('pull')||has('dips')||has('haut')||has('upper')||has('membres sup'))return'Membres sup'
  if(has('squat')||has('fente')||has('chaise')||has('pont')||has('fessier')||has('jambe')||has('membres inf')||has('leg'))return'Membres inf'
  return 'Membres sup'
}
function svgPlaceholder(label){
  const txt=encodeURIComponent((label||'Exo').slice(0,10))
  return 'data:image/svg+xml;utf8,'+`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#eef2ff'/><text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto' font-size='22' fill='#111'>${txt}</text></svg>`
}
const csvEl=()=>$('csvCat')
if(csvEl()) csvEl().addEventListener('change',async e=>{try{const f=e.target.files[0]; if(!f) return; const t=await f.text(); loadCatalogueCsv(t)}catch(err){logDiag('CSV load error: '+err.message,'err')}})
function loadCatalogueCsv(text){
  const lines=text.trim().split(/\r?\n/); const sep=text.includes(';')?';':text.includes('\t')?'\t':','
  const hdr=lines.shift().split(sep).map(s=>stripAccents(s.trim().toLowerCase()))
  const idx=k=>hdr.indexOf(k)
  const iFam=idx('famille'),iNom=idx('nom'),iTyp=idx('type'),iDesc=idx('description'),iU=(idx('unite')>-1?idx('unite'):idx('unite')),iN1=idx('pointsn1'),iN2=idx('pointsn2'),iImg=(idx('image')>-1?idx('image'):(idx('photo')>-1?idx('photo'):idx('img')))
  state.catalogue=lines.filter(Boolean).map(L=>{
    const c=L.split(sep); const nom=c[iNom]||''; const fam=normFamily(c[iFam]||'',nom)
    return {id:Math.random().toString(36).slice(2,9),famille:fam,nom:nom,type:((c[iTyp]||'REPS')+'').toUpperCase(),desc:c[iDesc]||'',unite:c[iU]||'',pointsN1:parseInt(c[iN1]||'0')||0,pointsN2:parseInt(c[iN2]||'0')||0,img:(c[iImg]||'')}
  })
  renderCatalogue()
}
function loadDemoCatalogue(){
  const csv=`Famille;Nom;Type;Description;Unite;PointsN1;PointsN2;Image
Cardio;Course 100m;TIME;Boucle courte;mm:ss;1;2;
Cardio;Course 200m;TIME;Boucle moyenne;mm:ss;2;3;
Force;Burpees;REPS;AMRAP 1 min;reps;1;2;
Force;Push-ups;REPS;Pompes strictes;reps;1;2;
Force;Chair (statique);TIME;Dos au mur;mm:ss;1;2;
Mobilite;Planche;TIME;Gainage;mm:ss;1;2;
Force;Squat poids du corps;REPS;Amplitude compl√®te;reps;1;2;
Force;Dips assis au banc;REPS;Contr√¥l√©;reps;1;2;
Mobilite;Pont fessier;REPS;Contr√¥l√©;reps;1;2;`
  loadCatalogueCsv(csv)
}
function renderCatalogue(){
  const q=($('f_search').value||'').toLowerCase(); const famSel=$('f_fam').value||''; const typSel=$('f_type').value||''
  $('f_fam').innerHTML='<option value="">(toutes)</option>'+FAMILLES.map(f=>`<option>${f}</option>`).join('')
  $('f_type').innerHTML='<option value="">(tous)</option>'+TYPES.map(t=>`<option>${t}</option>`).join('')
  const list=state.catalogue.filter(x=>(!famSel||x.famille===famSel)&&(!typSel||x.type===typSel)&&(!q||[x.nom,x.desc,x.famille].join(' ').toLowerCase().includes(q)))
  const host=$('catList'); host.innerHTML=''
  if(!list.length){ host.innerHTML='<div class="small">Aucun exercice (importe un catalogue ou charge l\'exemple).</div>'; return }
  list.forEach(ex=>host.appendChild(catItem(ex)))
}
function catItem(ex){
  const d=document.createElement('div'); d.className='item'
  const imgSrc=ex.img||svgPlaceholder(ex.nom)
  d.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
    <div class="skill">
      <img class="thumb" src="${imgSrc}" alt="${ex.nom}">
      <div>
        <div style="font-weight:800">${ex.nom}</div>
        <div class="meta">${ex.famille} ‚Ä¢ ${ex.type}${ex.unite? ' ‚Ä¢ '+ex.unite:''}</div>
        <div class="small">${ex.desc||''}</div>
        <div class="small">Niveau 1: <strong>${ex.pointsN1}</strong> pt ‚Ä¢ Niveau 2: <strong>${ex.pointsN2}</strong> pt</div>
      </div>
    </div>
    <div class="row"><button class="btn outline" onclick="addToSlot('${ex.id}')">‚ûï Ajouter √† mes skills</button></div>
  </div>`
  return d
}
function renderSlots(){
  const host=$('slots'); host.innerHTML=''
  state.slots.forEach((s,i)=>{
    const imgSrc=s.img||svgPlaceholder(s.nom)
    const box=document.createElement('div'); box.className='item'
    box.innerHTML=`<div class="skill">
      <img class="thumb" src="${imgSrc}" alt="${s.nom||'skill'}">
      <div><div style="font-weight:800">Skill ${i+1} ‚Äì ${s.nom||'(non choisi)'} </div>
      <div class="meta">Famille: ${s.famille||'-'} ${s.type? '‚Ä¢ '+s.type:''} ${s.unite? '‚Ä¢ '+s.unite:''}</div></div></div>
      <div class="row" style="margin-top:6px">
        <div><label class="small">Niveau</label>
          <select onchange="setLevel('${s.ref}',this.value)"><option ${s.niveau==1?'selected':''} value="1">L1 (${s.ptsN1} pt)</option><option ${s.niveau==2?'selected':''} value="2">L2 (${s.ptsN2} pt)</option></select>
        </div>
        <div><label class="small">R√©p√©titions pr√©vues</label><input class="small" value="${s.reps||''}" placeholder="ex: 25" onchange="setReps('${s.ref}',this.value)"></div>
        <div><label class="small">Actions</label><div class="row"><button class="btn outline" onclick="clearSlot('${s.ref}')">üóëÔ∏è Retirer</button></div></div>
      </div>`
    host.appendChild(box)
  })
  validateSlots()
}
function addToSlot(exId){
  const free=state.slots.find(s=>!s.exId); if(!free){alert('Tu as d√©j√† 4 skills.'); return}
  const ex=state.catalogue.find(x=>x.id===exId); if(!ex) return
  Object.assign(free,{exId:ex.id,nom:ex.nom,famille:ex.famille,type:ex.type,unite:ex.unite,ptsN1:ex.pointsN1,ptsN2:ex.pointsN2,niveau:1,img:ex.img||''})
  renderSlots()
}
function setLevel(ref,val){ const s=state.slots.find(x=>x.ref===ref); if(s){ s.niveau=parseInt(val||'1')||1; renderSlots() } }
function setReps(ref,val){ const s=state.slots.find(x=>x.ref===ref); if(s) s.reps=val }
function clearSlot(ref){ const s=state.slots.find(x=>x.ref===ref); if(!s) return; Object.assign(s,{exId:null,nom:'',famille:'',type:'REPS',unite:'',niveau:1,ptsN1:0,ptsN2:0,reps:'',img:''}); renderSlots() }
function validateSlots(){ $('toEval').disabled=!state.slots.every(s=>s.exId) }
function goEval(){
  state.identity={nom:$('b_nom').value.trim(),prenom:$('b_prenom').value.trim(),classe:$('b_classe').value.trim(),sex:$('b_sex').value.trim()}
  if(!state.identity.nom||!state.identity.prenom||!state.identity.classe){ alert('Renseigne Nom/Pr√©nom/Classe'); return }
  buildBlocks(); buildTimesTable(); go('eval')
}
let audioCtx=null
function ensureAudio(){ if(SAFE) return; try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume() }catch(e){ logDiag('Audio init: '+e.message,'warn') } }
function beep(freq=880,ms=150,gain=0.05){ if(SAFE) return; const el=$('enableBeep'); if(!el||!el.checked) return; ensureAudio(); if(!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(audioCtx.destination); o.start(); setTimeout(()=>{try{o.stop();o.disconnect();g.disconnect()}catch(_){}} ,ms)}
function vibe(p){ if(SAFE) return; const el=$('enableVibe'); if(el&&el.checked&&navigator.vibrate) navigator.vibrate(p) }
function flash(color='#fff7ed',ms=250){ const el=$('enableFlash'); if(!el||!el.checked) return; const fx=$('flashFx'); fx.style.background=color; fx.classList.add('show'); setTimeout(()=>fx.classList.remove('show'),ms) }
function fmt(s){const m=Math.floor(s/60).toString().padStart(2,'0'), ss=(s%60).toString().padStart(2,'0'); return m+':'+ss}
function updG(){ $('gDisplay').textContent=fmt(state.eval.gRemain) }
function updB(){ $('bDisplay').textContent=fmt(state.eval.bElapsed) }
function buildBlocks(){ const wrap=$('blocks'); wrap.innerHTML=''; for(let i=1;i<=10;i++){const d=document.createElement('div'); d.className='block'; d.id='blk'+i; d.textContent='Bloc '+i; wrap.appendChild(d)} hiBlocks() }
function hiBlocks(){ for(let i=1;i<=10;i++){ const d=$('blk'+i); if(d) d.classList.toggle('active',i===state.eval.block) } }
let lastWarn10=false
function startTimers(){ if(state.eval.timer) return; ensureAudio(); state.eval.timer=setInterval(()=>{
  if(state.eval.gRemain<=0){ finishEval(); return }
  state.eval.gRemain=Math.max(0,state.eval.gRemain-1); updG()
  state.eval.bElapsed=Math.min(120,state.eval.bElapsed+1); updB()
  const last10=(120-state.eval.bElapsed)<=10; $('bDisplay').classList.toggle('glow10',last10)
  if(last10 && !lastWarn10){ beep(740,120,0.04); flash('#fde68a',220); lastWarn10=true; $('phase').textContent='R√©cup√©ration' }
  if(state.eval.bElapsed===1){ beep(880,150); setTimeout(()=>beep(880,150),180); flash('#d1fae5',260); vibe([40]); $('phase').textContent='Travail' }
  if(state.eval.bElapsed>=120){ if(!state.eval.recorded[state.eval.block]){ state.eval.recorded[state.eval.block]={work:120,rest:0}; updateTimesRow(state.eval.block) } nextBlock() }
},1000)}
function pauseTimers(){ if(state.eval.timer){ clearInterval(state.eval.timer); state.eval.timer=null } }
function resetTimers(){ pauseTimers(); state.eval={gRemain:20*60,bElapsed:0,block:1,timer:null,recorded:{}}; updG(); updB(); hiBlocks(); buildTimesTable(); lastWarn10=false; $('bDisplay').classList.remove('glow10'); $('phase').textContent='Travail' }
function nextBlock(){ lastWarn10=false; $('bDisplay').classList.remove('glow10'); state.eval.block=Math.min(10,state.eval.block+1); state.eval.bElapsed=0; hiBlocks(); $('bIdx').textContent=state.eval.block; $('phase').textContent='Travail' }
function recordWork(){ const b=state.eval.block; if(state.eval.recorded[b]){ alert('Temps d√©j√† enregistr√© pour ce bloc.'); return } const w=Math.min(120,state.eval.bElapsed), r=120-w; state.eval.recorded[b]={work:w,rest:r}; updateTimesRow(b); $('phase').textContent='R√©cup√©ration'; beep(660,120,0.05); flash('#e0f2fe',250); vibe([25]) }
function buildTimesTable(){ const tb=$('timesTbody'); tb.innerHTML=''; for(let i=1;i<=10;i++){ const tr=document.createElement('tr'); tr.id='tr'+i; tr.innerHTML=`<td>${i}</td><td id="w${i}">-</td><td id="r${i}">-</td><td><button class="btn outline" onclick="editRow(${i})">‚úèÔ∏è</button></td>`; tb.appendChild(tr) } }
function updateTimesRow(i){ const rec=state.eval.recorded[i]; if(!rec) return; const w=$('w'+i), r=$('r'+i); if(w) w.textContent=rec.work; if(r) r.textContent=rec.rest }
function editRow(i){ const rec=state.eval.recorded[i]||{work:120,rest:0}; const w=prompt('Temps de travail (sec)',rec.work); const W=parseInt(w||rec.work); const R=Math.max(0,120-(Number.isFinite(W)?W:rec.work)); state.eval.recorded[i]={work:W,rest:R}; updateTimesRow(i) }
function finishEval(){
  pauseTimers()
  const s=state.identity; $('sumIdent').textContent=(s.prenom||'')+' '+(s.nom||'')+' ‚Äì '+(s.classe||'')
  const skills=state.slots.map((x,i)=>{const img=x.img||svgPlaceholder(x.nom); return `<div class="item"><div class="skill"><img class="thumb" src="${img}" alt="${x.nom}"><div><div style="font-weight:800">Skill ${i+1} ‚Äì ${x.nom}</div><div class="meta">Famille: ${x.famille} ‚Ä¢ Type: ${x.type}${x.unite? ' ‚Ä¢ '+x.unite:''} ‚Ä¢ Niveau: L${x.niveau} (${x.niveau==1?x.ptsN1:x.ptsN2} pt) ‚Ä¢ R√©p√©titions pr√©vues: ${x.reps||'-'}</div></div></div></div>`}).join('')
  $('sumSkills').innerHTML=skills
  const rows=Array.from({length:10},(_,i)=>{const r=state.eval.recorded[i+1]||{work:120,rest:0}; return `<tr><td>${i+1}</td><td>${r.work}</td><td>${r.rest}</td></tr>`}).join('')
  $('sumTimes').innerHTML=`<div style="overflow:auto"><table class="table"><thead><tr><th>#</th><th>Travail (sec)</th><th>Pause (sec)</th></tr></thead><tbody>${rows}</tbody></table></div>`
  go('summary')
}
function buildPayloadCompact(){
  const s=state.identity, out={App:'CT-BlocEleve',schema:'v1',Nom:s.nom,Prenom:s.prenom,Classe:s.classe,Sexe:s.sex||''}
  state.slots.forEach((sk,i)=>{ const n=i+1; out['S'+n]=sk.nom; out['S'+n+'_fam']=sk.famille; out['S'+n+'_niv']='L'+sk.niveau; out['S'+n+'_rep']=sk.reps })
  const W=[],R=[]; for(let i=1;i<=10;i++){ const rec=state.eval.recorded[i]||{work:120,rest:0}; W.push(rec.work); R.push(rec.rest) }
  out.W=W; out.R=R; out.Feel=$('sumFeel').value||''; return out
}
function exportCsv(){
  const s=state.identity; const head=['Nom','Pr√©nom','Classe','Sexe','S1','S1_fam','S1_niv','S1_rep','S2','S2_fam','S2_niv','S2_rep','S3','S3_fam','S3_niv','S3_rep','S4','S4_fam','S4_niv','S4_rep','Feel',...Array.from({length:10},(_,i)=>`W${i+1}`),...Array.from({length:10},(_,i)=>`R${i+1}`)]
  const vals=[s.nom,s.prenom,s.classe,s.sex||'',...state.slots.flatMap(sk=>[sk.nom,sk.famille,'L'+sk.niveau,sk.reps||'']),$('sumFeel').value||'',...Array.from({length:10},(_,i)=>(state.eval.recorded[i+1]?.work??120)),...Array.from({length:10},(_,i)=>(state.eval.recorded[i+1]?.rest??0))]
  const csv=[head.join(';'),vals.map(v=>{const a=(v??'').toString(); return /[";\n]/.test(a)?'"'+a.replace(/"/g,'""')+'"':a}).join(';')].join('\n')
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='crosstraining-projet-eleve.csv'; a.click(); URL.revokeObjectURL(a.href)
}
function openQR(){
  const wrap=$('qrWrap'); wrap.innerHTML=''; const payload=buildPayloadCompact()
  const pre=document.createElement('pre'); pre.style.maxWidth='680px'; pre.style.whiteSpace='pre-wrap'; pre.style.wordBreak='break-word'; pre.textContent=JSON.stringify(payload)
  const box=document.createElement('div'); box.className='item'; box.style.maxWidth='720px'; box.innerHTML=`<div style="font-weight:800;text-align:center">${state.identity.prenom||''} ${state.identity.nom||''} ‚Äì ${state.identity.classe||''}</div>`
  box.appendChild(pre); const actions=document.createElement('div'); actions.className='row'; actions.style.justifyContent='center'
  const btn=document.createElement('button'); btn.className='btn outline'; btn.textContent='üìã Copier le contenu'; btn.onclick=()=>navigator.clipboard.writeText(pre.textContent)
  actions.appendChild(btn); box.appendChild(actions); wrap.appendChild(box)
  const d=$('qrDlg'); if(d.showModal) d.showModal(); else d.style.display='block'
}
function closeQR(){ const d=$('qrDlg'); if(d.close) d.close(); else d.style.display='none' }
window.addEventListener('DOMContentLoaded',()=>{
  try{ renderSlots(); buildTimesTable(); loadDemoCatalogue(); renderCatalogue(); logDiag('Catalogue d√©mo charg√©','ok') }catch(err){ logDiag('INIT: '+err.message,'err') }
})
</script>
</body>
</html>
