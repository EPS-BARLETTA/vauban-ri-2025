<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CrossTraining Planner ‚Äì Lyc√©e Vauban</title>
  <style>
    :root{
      --green:#2ecc71; /* Accueil */
      --blue:#3498db;  /* Actions */
      --red:#e74c3c;   /* R√©initialiser */
      --yellow:#f1c40f;/* Impression */
      --violet:#9b59b6;/* Aide */
      --bg:#f7f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --ink:#111827;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,rgba(255,255,255,.88));border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:1.35rem}
    .tagline{color:var(--muted);font-size:.9rem}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .btn{appearance:none;border:1px solid transparent;background:var(--blue);color:#fff;padding:10px 14px;border-radius:14px;font-weight:650;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.green{background:var(--green)}
    .btn.red{background:var(--red)}
    .btn.violet{background:var(--violet)}
    .btn.yellow{background:var(--yellow);color:#111}
    .btn.outline{background:#fff;color:#111;border-color:var(--border)}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px}
    .panel h2{margin:0 0 10px;font-size:1.05rem}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}

    .mapping{display:grid;grid-template-columns:1fr 2fr;gap:10px}
    .mapping label{color:var(--muted);font-size:.9rem}
    select, input[type="text"], input[type="number"], textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font:inherit}

    .dropzone{border:2px dashed var(--border);border-radius:16px;padding:16px;text-align:center;color:var(--muted);background:#fff}
    .dropzone.drag{border-color:var(--blue);background:#f0f7ff}

    .columnsWrap{overflow:auto;padding-bottom:8px}
    .columns{display:flex;gap:12px;min-height:120px}
    .col{min-width:300px;background:var(--card);border:1px solid var(--border);border-radius:18px}
    .col header{position:sticky;top:0}
    .colTitle{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:800}
    .cards{padding:12px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:10px}
    .card h4{margin:0 0 6px;font-size:1.05rem}
    .meta{font-size:.85rem;color:var(--muted)}
    .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .badge{font-size:.75rem;border-radius:999px;padding:4px 8px;border:1px solid var(--border);background:#fafafa}
    .cap{font-weight:700}
    .cap.ok{color:#0d9488}
    .cap.warn{color:#ca8a04}
    .cap.full{color:#b91c1c}
    .type{display:inline-flex;gap:6px;align-items:center;font-size:.8rem;border:1px solid var(--border);padding:2px 8px;border-radius:999px;background:#f9fafb;margin-left:6px}

    .legend{display:flex;gap:8px;flex-wrap:wrap}
    .legend .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.85rem}

    footer{margin:28px 0 60px;color:var(--muted);font-size:.85rem;text-align:center}

    .row{display:flex;gap:8px;flex-wrap:wrap}

    /* Dialogs */
    dialog{border:1px solid var(--border);border-radius:18px;padding:0}
    dialog .dlg{padding:16px}

    .wodCard{padding:18px;border:1px dashed var(--border);border-radius:16px;background:#fff}
    .wodTitle{font-size:1.3rem;font-weight:800;margin:0 0 6px}
    .wodSub{color:var(--muted);margin:0 0 12px}
    .wodBlock{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fbfbff}
    .wodList{margin:6px 0 0 18px}

    /* Print */
    @media print{
      header,.panel,#help,#timerDlg,#wodDlg{display:none!important}
      .columns{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
      .col{break-inside:avoid}
      body{background:#fff}
      footer{position:fixed;bottom:8px;left:0;right:0}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
      <div>
        <h1>CrossTraining Planner ‚Äì WOD Builder</h1>
        <div class="tagline">Import depuis Numbers (CSV) ‚Üí mapping ‚Üí vue par jour & cr√©neau ‚Üí cartes WOD, groupes & timer. Compatible iPad. </div>
      </div>
      <div class="toolbar">
        <button class="btn green" onclick="scrollToTop()">üè† Accueil</button>
        <label class="btn outline" for="csvFile">üì• Importer CSV</label>
        <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none"/>
        <button class="btn" onclick="exportViewCsv()">‚¨áÔ∏è Export CSV</button>
        <button class="btn yellow" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
        <button class="btn red" onclick="resetAll()">‚ôªÔ∏è R√©initialiser</button>
        <button class="btn violet" onclick="toggleHelp()">‚ùì Aide</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel" id="ingest">
      <h2>1) Import du fichier (CSV export√© depuis Numbers)</h2>
      <div class="dropzone" id="dropzone">Glissez-d√©posez votre CSV ici‚Ä¶ ou cliquez sur <strong>Importer CSV</strong> ci-dessus.<br>
        <small>Numbers ‚Üí Fichier ‚Üí <em>Exporter vers</em> ‚Üí <em>CSV</em> (s√©parateur auto-d√©tect√©)</small>
      </div>
      <div style="margin-top:12px">
        <textarea id="paste" rows="4" placeholder="‚Ä¶ou collez des lignes CSV ici"></textarea>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn outline" onclick="usePasted()">‚ÜòÔ∏è Utiliser le texte coll√©</button>
          <button class="btn outline" onclick="loadDemo()">üß™ Charger un exemple</button>
        </div>
      </div>
    </section>

    <section class="panel" id="mappingPanel" style="display:none">
      <h2>2) Associer vos colonnes</h2>
      <div class="mapping" id="mappingForm"></div>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn" onclick="applyMapping()">üéØ Appliquer le mapping</button>
      </div>
    </section>

    <section class="panel" id="filtersPanel" style="display:none">
      <h2>Filtres & options</h2>
      <div class="grid" style="margin-top:6px">
        <div style="grid-column:span 3">
          <label>Filtrer par jour</label>
          <select id="dayFilter" onchange="render()"></select>
        </div>
        <div style="grid-column:span 3">
          <label>Filtrer par cr√©neau</label>
          <select id="slotFilter" onchange="render()"></select>
        </div>
        <div style="grid-column:span 3">
          <label>Filtrer par type</label>
          <select id="typeFilter" onchange="render()"></select>
        </div>
        <div style="grid-column:span 3">
          <label>Filtrer par niveau</label>
          <select id="levelFilter" onchange="render()"></select>
        </div>
      </div>
    </section>

    <section id="view" class="panel" style="display:none">
      <h2 style="margin-bottom:8px">3) Planning par jour & cr√©neau</h2>
      <div class="columnsWrap"><div class="columns" id="columns"></div></div>
    </section>

    <footer>CrossTraining Planner ‚Ä¢ ScanProf-style UI ‚Ä¢ √âquipe EPS Lyc√©e Vauban ‚Äì LUXEMBOURG ‚Äì JB</footer>
  </main>

  <!-- Aide -->
  <dialog id="help"><div class="dlg">
    <h3 style="margin:0 0 8px">Aide rapide</h3>
    <ol>
      <li><strong>Exporter depuis Numbers</strong> en CSV.</li>
      <li><strong>Importer</strong> le CSV (bouton / drag / coller).</li>
      <li><strong>Mapper</strong> : Jour, Cr√©neau, Titre s√©ance, Type (AMRAP/EMOM/‚Ä¶), Dur√©e, Tours, Exercices, Mat√©riel, Niveau, Prof, Lieu, Capacit√©, Inscrits.</li>
      <li><strong>Planning</strong> : cartes par <em>jour + cr√©neau</em>, avec type, dur√©e, mat√©riel, capacit√©.</li>
      <li><strong>Actions carte</strong> : Carte WOD (imprimable), Timer (EMOM/AMRAP/For Time), Groupes (stations/√©quipes), Export CSV/PDF.</li>
    </ol>
    <p style="color:var(--muted);font-size:.9rem">Boutons harmonis√©s : üü© Accueil ‚Ä¢ üîµ Actions ‚Ä¢ üî¥ R√©initialiser ‚Ä¢ üü£ Aide ‚Ä¢ üü° Impression/PDF.</p>
    <div class="toolbar" style="justify-content:flex-end"><button class="btn outline" onclick="toggleHelp()">Fermer</button></div>
  </div></dialog>

  <!-- WOD Card -->
  <dialog id="wodDlg"><div class="dlg">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>Carte WOD</strong>
      <div class="toolbar"><button class="btn yellow" onclick="window.print()">üñ®Ô∏è Imprimer</button><button class="btn outline" onclick="closeWod()">Fermer</button></div>
    </div>
    <div id="wodContent" class="wodCard" style="margin-top:12px"></div>
  </div></dialog>

  <!-- Timer -->
  <dialog id="timerDlg"><div class="dlg">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>‚è±Ô∏è Timer CrossTraining</strong>
      <button class="btn outline" onclick="closeTimer()">Fermer</button>
    </div>
    <div style="margin-top:12px" class="grid">
      <div style="grid-column:span 4">
        <label>Mode</label>
        <select id="tmMode">
          <option>EMOM</option>
          <option>AMRAP</option>
          <option>For Time</option>
          <option>Tabata</option>
        </select>
      </div>
      <div style="grid-column:span 4"><label>Dur√©e (min)</label><input type="number" id="tmMinutes" value="10" min="1"></div>
      <div style="grid-column:span 4"><label>Intervalle (sec) ‚Äì EMOM/Tabata</label><input type="number" id="tmInterval" value="60" min="5"></div>
    </div>
    <div style="text-align:center;margin:16px 0 8px;font-size:3rem;font-weight:900" id="tmDisplay">00:00</div>
    <div class="row" style="justify-content:center">
      <button class="btn" onclick="tmStart()">‚ñ∂Ô∏è Start</button>
      <button class="btn outline" onclick="tmPause()">‚è∏Ô∏è Pause</button>
      <button class="btn red" onclick="tmReset()">‚ü≤ Reset</button>
    </div>
  </div></dialog>

<script>
// --------------------- State ---------------------
let rawRows = []
let headers = []
let delimiter = ','
let mapping = {
  day:null,       // Jour
  slot:null,      // 12-13 ou 12h-13h
  start:null,
  end:null,
  title:null,     // Titre s√©ance (WOD)
  type:null,      // AMRAP / EMOM / For Time / Tabata
  duration:null,  // minutes
  rounds:null,    // nombre de tours (optionnel)
  exercises:null, // texte multi-lignes
  equipment:null, // liste s√©par√©e par virgules / retours
  level:null,     // D√©butant / Inter / Avanc√© / Lyc√©e / Coll√®ge
  teacher:null,   // Prof
  room:null,      // Salle / Lieu
  capacity:null,  // Capacit√© max
  count:null,     // Nb inscrits
  list:null       // Liste √©l√®ves
}

const JOUR_ORDER = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche']

// --------------------- Utils ---------------------
function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}) }
function toggleHelp(){ const d=document.getElementById('help'); d.open ? d.close() : d.showModal() }
function resetAll(){ localStorage.removeItem('ctplanner'); location.reload() }

function saveState(){ const s={rawRows,headers,delimiter,mapping}; localStorage.setItem('ctplanner', JSON.stringify(s)) }
function loadState(){ const s=localStorage.getItem('ctplanner'); if(!s) return false; try{ const st=JSON.parse(s); rawRows=st.rawRows||[]; headers=st.headers||[]; delimiter=st.delimiter||','; mapping=Object.assign(mapping, st.mapping||{}); if(rawRows.length){ showMapping(); if(mapping.day&&(mapping.slot||(mapping.start&&mapping.end))&&mapping.title){ applyMapping() } return true } }catch(e){} return false }

function guessDelimiter(text){ const c=(text.match(/,/g)||[]).length, s=(text.match(/;/g)||[]).length, t=(text.match(/\t/g)||[]).length; if(t>c&&t>s) return '\t'; if(s>c) return ';'; return ',' }

function parseCSV(text){
  delimiter = guessDelimiter(text)
  const rows=[]; let i=0, field='', row=[], inQ=false
  const pushF=()=>{ row.push(field); field='' }
  const pushR=()=>{ rows.push(row); row=[] }
  while(i<text.length){ const ch=text[i]
    if(inQ){ if(ch==='"'){ if(text[i+1]==='"'){ field+='"'; i++ } else { inQ=false } } else { field+=ch } }
    else { if(ch==='"') inQ=true; else if(ch===delimiter) pushF(); else if(ch==='\n'){ pushF(); pushR() } else if(ch==='\r'){} else field+=ch }
    i++
  }
  if(field.length||row.length){ pushF(); pushR() }
  return rows
}

function canonicalizeHeader(h){ return (h||'').toString().trim() }

// --------------------- Ingest ---------------------
function handleTable(rows){ if(!rows.length){ alert('CSV vide'); return } headers = rows[0].map(canonicalizeHeader); rawRows = rows.slice(1).map(r=>{ const o={}; headers.forEach((h,idx)=>o[h]=r[idx]??''); return o }); saveState(); showMapping() }

function showMapping(){
  document.getElementById('mappingPanel').style.display='block'
  const form=document.getElementById('mappingForm'); form.innerHTML=''
  const makeSel=(id,label,ph='(aucune)')=>{ const wrap=document.createElement('div'); const lab=document.createElement('label'); lab.textContent=label; const sel=document.createElement('select'); sel.id='map_'+id; const o0=document.createElement('option'); o0.value=''; o0.textContent=ph; sel.appendChild(o0); headers.forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=h; sel.appendChild(o) }); if(mapping[id]) sel.value=mapping[id]; wrap.appendChild(lab); wrap.appendChild(sel); form.appendChild(wrap) }
  makeSel('day','Jour');
  makeSel('slot','Cr√©neau (ex: 12-13)');
  makeSel('start','Heure d√©but (si pas de cr√©neau)');
  makeSel('end','Heure fin (si pas de cr√©neau)');
  makeSel('title','Titre s√©ance');
  makeSel('type','Type (AMRAP / EMOM / For Time / Tabata)');
  makeSel('duration','Dur√©e (min)');
  makeSel('rounds','Tours (optionnel)');
  makeSel('exercises','Exercices (texte multi-lignes)');
  makeSel('equipment','Mat√©riel (liste)');
  makeSel('level','Niveau');
  makeSel('teacher','Prof');
  makeSel('room','Lieu / Salle');
  makeSel('capacity','Capacit√©');
  makeSel('count','Nb inscrits');
  makeSel('list','Liste √©l√®ves');
  document.getElementById('filtersPanel').style.display='block'
}

function applyMapping(){ Object.keys(mapping).forEach(id=>{ const sel=document.getElementById('map_'+id); if(sel) mapping[id]=sel.value||null }); saveState(); render() }

// --------------------- Transform ---------------------
function normSlot(start,end,slot){
  const norm=(s)=>s.toString().trim().replace(/[hH]/,'h')
  if(slot){ let x=slot.toString().trim(); x=x.replace(/\s+/g,'').replace(/[‚Äì‚Äî]/g,'-')
    if(/^(\d{1,2})h?(\d{0,2})?-(\d{1,2})h?(\d{0,2})?$/.test(x)){ const m=x.match(/(\d{1,2})h?(\d{0,2})?-(\d{1,2})h?(\d{0,2})?/); const h1=(m[1]||'').padStart(2,'0'), m1=(m[2]||'00').padStart(2,'0'); const h2=(m[3]||'').padStart(2,'0'), m2=(m[4]||'00').padStart(2,'0'); return `${h1}:${m1}-${h2}:${m2}` }
    const mm=x.match(/(\d{1,2})-(\d{1,2})/); if(mm){ const h1=mm[1].padStart(2,'0'), h2=mm[2].padStart(2,'0'); return `${h1}:00-${h2}:00` }
    return slot
  }
  if(start&&end){ const fix=t=>{ const m=t.toString().match(/(\d{1,2})(?:h|:)?(\d{0,2})/); if(!m) return t; const h=m[1].padStart(2,'0'), mm=(m[2]||'00').padStart(2,'0'); return `${h}:${mm}` }; return `${fix(norm(start))}-${fix(norm(end))}` }
  return ''
}
function toInt(x){ if(x==null) return 0; const s=x.toString().replace(/\s/g,'').replace(',', '.'); const n=parseFloat(s); if(Number.isFinite(n)) return Math.round(n); return 0 }
function splitList(txt){ if(!txt) return []; return txt.split(/\r?\n|,|;|\//).map(s=>s.trim()).filter(Boolean) }

function normalizeRows(){
  const out=[]
  for(const r of rawRows){
    const obj={
      day: mapping.day? (r[mapping.day]||'').toString().trim():'',
      slot: normSlot(mapping.start? r[mapping.start]:null, mapping.end? r[mapping.end]:null, mapping.slot? r[mapping.slot]:null),
      title: mapping.title? (r[mapping.title]||'').toString().trim():'',
      type: mapping.type? (r[mapping.type]||'').toString().trim().toUpperCase():'',
      duration: mapping.duration? toInt(r[mapping.duration]): 0,
      rounds: mapping.rounds? toInt(r[mapping.rounds]): 0,
      exercises: mapping.exercises? (r[mapping.exercises]||'').toString().trim():'',
      equipment: mapping.equipment? splitList(r[mapping.equipment]):[],
      level: mapping.level? (r[mapping.level]||'').toString().trim():'',
      teacher: mapping.teacher? (r[mapping.teacher]||'').toString().trim():'',
      room: mapping.room? (r[mapping.room]||'').toString().trim():'',
      capacity: mapping.capacity? toInt(r[mapping.capacity]): 0,
      label:'',
      count: 0,
      list: []
    }
    if(mapping.list){ obj.list=splitList(r[mapping.list]); obj.count=obj.list.length }
    else if(mapping.count){ obj.count=toInt(r[mapping.count]) }
    out.push(obj)
  }
  return out
}

function sortByDaySlot(a,b){ const da=JOUR_ORDER.indexOf(a.day); const db=JOUR_ORDER.indexOf(b.day); if(da!==db) return da-db; const sa=(a.slot||'').split('-')[0]; const sb=(b.slot||'').split('-')[0]; return sa.localeCompare(sb) }

// --------------------- Render ---------------------
function render(){
  const rows=normalizeRows()
  // filters
  const daySel=document.getElementById('dayFilter')
  const slotSel=document.getElementById('slotFilter')
  const typeSel=document.getElementById('typeFilter')
  const levelSel=document.getElementById('levelFilter')
  const days=[...new Set(rows.map(r=>r.day).filter(Boolean))]
  const slots=[...new Set(rows.map(r=>r.slot).filter(Boolean))]
  const types=[...new Set(rows.map(r=>r.type).filter(Boolean))]
  const levels=[...new Set(rows.map(r=>r.level).filter(Boolean))]
  function refill(sel,list){ const cur=sel.value; sel.innerHTML='<option value="">(tous)</option>'+list.map(v=>`<option>${v}</option>`).join(''); if(list.includes(cur)) sel.value=cur }
  refill(daySel,days); refill(slotSel,slots); refill(typeSel,types); refill(levelSel,levels)

  const fDay=daySel.value||null, fSlot=slotSel.value||null, fType=typeSel.value||null, fLvl=levelSel.value||null
  const filtered=rows.filter(r=>(!fDay||r.day===fDay)&&(!fSlot||r.slot===fSlot)&&(!fType||r.type===fType)&&(!fLvl||r.level===fLvl))

  // group by day+slot
  const groups={}
  for(const r of filtered){ const key=`${r.day}__${r.slot}`; if(!groups[key]) groups[key]={day:r.day,slot:r.slot,items:[]}; groups[key].items.push(r) }
  const keys=Object.keys(groups).sort((ka,kb)=>{ const A=groups[ka], B=groups[kb]; return sortByDaySlot(A,B) })

  const cols=document.getElementById('columns'); cols.innerHTML=''
  for(const k of keys){ const g=groups[k]; const col=document.createElement('div'); col.className='col'
    const head=document.createElement('div'); head.className='colTitle'; head.textContent=`${g.day||'Jour ?'} ‚Ä¢ ${g.slot||'Cr√©neau ?'}`
    const cards=document.createElement('div'); cards.className='cards'
    g.items.sort((a,b)=> (a.title||'').localeCompare(b.title||''))

    for(const it of g.items){ const card=document.createElement('div'); card.className='card'
      const title=document.createElement('h4'); title.textContent=it.title||'(S√©ance ?)'
      const type=document.createElement('span'); type.className='type'; type.textContent=it.type||'TYPE?'; title.appendChild(type); card.appendChild(title)

      const meta=document.createElement('div'); meta.className='meta';
      const bits=[ it.duration?`‚è≥ ${it.duration} min`:null, it.rounds?`üîÅ ${it.rounds} tours`:null, it.level?`üéöÔ∏è ${it.level}`:null, it.teacher?`üë©‚Äçüè´ ${it.teacher}`:null, it.room?`üìç ${it.room}`:null]
      meta.innerHTML=bits.filter(Boolean).join(' ¬∑ ')
      card.appendChild(meta)

      if(it.exercises){ const bx=document.createElement('div'); bx.className='wodBlock';
        const lines=it.exercises.split(/\r?\n|\s*;\s*/).map(s=>s.trim()).filter(Boolean)
        const ul=document.createElement('ul'); ul.className='wodList'; lines.forEach(L=>{ const li=document.createElement('li'); li.textContent=L; ul.appendChild(li) });
        bx.appendChild(ul); card.appendChild(bx)
      }

      if(it.equipment && it.equipment.length){ const b=document.createElement('div'); b.className='badges'; it.equipment.forEach(eq=>{ const tag=document.createElement('span'); tag.className='badge'; tag.textContent=eq; b.appendChild(tag) }); card.appendChild(b) }

      // capacity
      let capCls='ok'; if(it.capacity>0){ if(it.count>=it.capacity) capCls='full'; else if(it.count>=it.capacity*0.8) capCls='warn' }
      const cap=document.createElement('div'); cap.className='cap '+capCls; const ratio = it.capacity? `${it.count}/${it.capacity}` : `${it.count}`; cap.innerHTML=`üë• ${ratio}`; card.appendChild(cap)

      // actions
      const actions=document.createElement('div'); actions.className='row'; actions.style.marginTop='8px'
      const b1=btn('üßæ Carte WOD',()=>openWod(it))
      const b2=btn('‚è±Ô∏è Timer',()=>openTimer(it))
      const b3=btn('üë• Groupes',()=>openGroups(it))
      actions.appendChild(b1); actions.appendChild(b2); actions.appendChild(b3); card.appendChild(actions)

      // names preview
      if(it.list && it.list.length){ const b=document.createElement('div'); b.className='badges'; it.list.slice(0,6).forEach(n=>{ const t=document.createElement('span'); t.className='badge'; t.textContent=n; b.appendChild(t) }); if(it.list.length>6){ const t=document.createElement('span'); t.className='badge'; t.textContent=`+${it.list.length-6} autres`; b.appendChild(t) } card.appendChild(b) }

      cards.appendChild(card)
    }

    col.appendChild(head); const cont=document.createElement('div'); cont.className='cards'; cont.appendChild(cards); col.appendChild(cont); document.getElementById('columns').appendChild(col)
  }

  document.getElementById('view').style.display='block'; document.getElementById('filtersPanel').style.display='block'
}

function btn(label,fn){ const b=document.createElement('button'); b.className='btn outline'; b.textContent=label; b.onclick=fn; return b }

// --------------------- Exports ---------------------
function exportViewCsv(){ const rows=normalizeRows(); const out=[[ 'Jour','Cr√©neau','S√©ance','Type','Dur√©e(min)','Tours','Niveau','Prof','Lieu','Mat√©riel','Inscrits','Capacit√©' ]]; for(const r of rows){ out.push([r.day,r.slot,r.title,r.type,r.duration||'',r.rounds||'',r.level,r.teacher,r.room,(r.equipment||[]).join(' / '),r.count||'',r.capacity||'']) } const csv=toCSV(out); const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='crosstraining-planning.csv'; a.click(); URL.revokeObjectURL(a.href) }
function toCSV(matrix){ return matrix.map(row=>row.map(cell=>{ const s=(cell??'').toString(); if(/[\n",;]/.test(s)) return '"'+s.replace(/"/g,'""')+'"'; return s }).join(';')).join('\n') }

// --------------------- Input handlers ---------------------
const fileInput=document.getElementById('csvFile')
fileInput.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const text=await f.text(); const rows=parseCSV(text); handleTable(rows) })
const dz=document.getElementById('dropzone'); ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault(); dz.classList.add('drag')})); ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault(); dz.classList.remove('drag')})); dz.addEventListener('drop', async (e)=>{ const f=e.dataTransfer.files[0]; if(!f) return; const text=await f.text(); const rows=parseCSV(text); handleTable(rows) })
function usePasted(){ const text=document.getElementById('paste').value.trim(); if(!text){ alert('Collez d\'abord du CSV.'); return } handleTable(parseCSV(text)) }
function loadDemo(){ const demo=`Jour;Cr√©neau;Titre;Type;Dur√©e;Tours;Exercices;Mat√©riel;Niveau;Prof;Lieu;Capacit√©;Inscrits\nLundi;12-13;WOD Force;EMOM;12;0;1) 5 back squats @60%\n2) 5 back squats @65%\n3) 5 back squats @70%;barres, disques;Lyc√©e;Caro;Salle 1;24;Alice,Bob,Chlo√©,David\nLundi;13-14;WOD Metcon;AMRAP;15;0;10 push-ups;10 kettlebell swings;10 sit-ups;kettlebells,tapis;Lyc√©e;JB;Gymnase;20;Eli,Farah,Gabriel\nMardi;12-13;Tabata Core;Tabata;8;8;20" travail / 10" repos x 8;none;Coll√®ge;Ambroise;Salle 2;16;Hugo,In√®s\nJeudi;12-13;For Time 3 tours;For Time;20;3;400m course;20 air squats;15 burpees;tapis;Lyc√©e;Nordine;Piste;18;`;
  const rows=parseCSV(demo); handleTable(rows) }

// --------------------- WOD Card ---------------------
function openWod(it){ const dlg=document.getElementById('wodDlg'); const box=document.getElementById('wodContent'); box.innerHTML=''; const t=document.createElement('div'); t.className='wodTitle'; t.textContent=it.title||'S√©ance'; const sub=document.createElement('div'); sub.className='wodSub'; sub.textContent=[ it.type?`Type: ${it.type}`:null, it.duration?`Dur√©e: ${it.duration} min`:null, it.rounds?`Tours: ${it.rounds}`:null, it.level?`Niveau: ${it.level}`:null, it.teacher?`Prof: ${it.teacher}`:null, it.room?`Lieu: ${it.room}`:null ].filter(Boolean).join(' ‚Ä¢ '); const ex=document.createElement('div'); ex.className='wodBlock'; const lines=(it.exercises||'').split(/\r?\n|\s*;\s*/).map(s=>s.trim()).filter(Boolean); const ul=document.createElement('ul'); ul.className='wodList'; lines.forEach(L=>{ const li=document.createElement('li'); li.textContent=L; ul.appendChild(li) }); ex.appendChild(ul); const eq=document.createElement('div'); eq.style.marginTop='8px'; if(it.equipment&&it.equipment.length){ eq.innerHTML='<strong>Mat√©riel :</strong> '+it.equipment.join(' ‚Ä¢ ') } box.appendChild(t); box.appendChild(sub); box.appendChild(ex); box.appendChild(eq); dlg.showModal() }
function closeWod(){ document.getElementById('wodDlg').close() }

// --------------------- Timer ---------------------
let tmTimer=null, tmRemain=0, tmMode='EMOM', tmInterval=60
function openTimer(it){ document.getElementById('timerDlg').showModal(); document.getElementById('tmDisplay').textContent='00:00'; document.getElementById('tmMinutes').value= it.duration||10; document.getElementById('tmMode').value = it.type? it.type.toUpperCase() : 'EMOM' }
function closeTimer(){ tmPause(); document.getElementById('timerDlg').close() }
function tmStart(){ const minutes=parseInt(document.getElementById('tmMinutes').value||'0'); const interval=parseInt(document.getElementById('tmInterval').value||'60'); tmInterval=interval; tmMode=document.getElementById('tmMode').value; if(!tmRemain) tmRemain=minutes*60; if(tmTimer) return; tmTimer=setInterval(()=>{ tmRemain=Math.max(0, tmRemain-1); updateTmDisplay(); if((tmMode==='EMOM'||tmMode==='Tabata') && tmInterval>0 && tmRemain%tmInterval===0 && tmRemain>0){ flash() } if(tmRemain===0){ flash(true); tmPause() } },1000) }
function tmPause(){ if(tmTimer){ clearInterval(tmTimer); tmTimer=null } }
function tmReset(){ tmPause(); tmRemain=0; document.getElementById('tmDisplay').textContent='00:00' }
function updateTmDisplay(){ const m=Math.floor(tmRemain/60).toString().padStart(2,'0'); const s=(tmRemain%60).toString().padStart(2,'0'); document.getElementById('tmDisplay').textContent=`${m}:${s}` }
function flash(final=false){ const el=document.getElementById('tmDisplay'); el.style.transition='none'; el.style.background= final? '#d1fae5' : '#fff7ed'; el.style.borderRadius='12px'; setTimeout(()=>{ el.style.transition='background 400ms'; el.style.background='transparent' },300) }

// --------------------- Groups (simple stations/√©quipes) ---------------------
function openGroups(it){ const names=(it.list||[]).slice(); if(!names.length){ alert('Pas de liste d\'inscrits trouv√©e. Renseignez la colonne "Inscrits" ou "Liste √©l√®ves".'); return } const size = prompt('Taille des groupes / stations ? (ex: 4)', '4'); const n=parseInt(size||'4'); if(!n||n<1){ alert('Taille invalide'); return } const groups=[]; // shuffle
  for(let i=names.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [names[i],names[j]]=[names[j],names[i]] }
  while(names.length){ groups.push(names.splice(0,n)) }
  // show result in a printable dialog via WOD card box
  const dlg=document.getElementById('wodDlg'); const box=document.getElementById('wodContent'); box.innerHTML=''; const title=document.createElement('div'); title.className='wodTitle'; title.textContent=`Groupes ‚Äì ${it.title||'S√©ance'}`; box.appendChild(title); groups.forEach((g,idx)=>{ const block=document.createElement('div'); block.className='wodBlock'; block.style.marginTop='8px'; const h=document.createElement('div'); h.style.fontWeight='800'; h.textContent=`Groupe ${idx+1} (${g.length})`; block.appendChild(h); const ul=document.createElement('ul'); ul.className='wodList'; g.forEach(nm=>{ const li=document.createElement('li'); li.textContent=nm; ul.appendChild(li) }); block.appendChild(ul); box.appendChild(block) }); const meta=document.createElement('div'); meta.className='wodSub'; meta.textContent=`Total: ${groups.reduce((a,g)=>a+g.length,0)} √©l√®ves ‚Ä¢ taille ~${n}`; box.appendChild(meta); dlg.showModal() }
</script>
</body>
</html>
